name: Build & Release EHR TEST

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 7.0.2)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout main
      # -----------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Stub Crowdin step
        run: echo "Skipping Crowdin sync (no secrets in test mode)"


      # -----------------------------
      # 3. Setup .NET
      # -----------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # -----------------------------
      # 4. Build main mod (EHR)
      # -----------------------------
      - name: Build EHR
        run: |
          dotnet publish EHR.csproj -c Release -o build/

      # -----------------------------
      # 5. Build CTA (Control Panel)
      # -----------------------------
      - name: Build CustomTeamAssigner (Control Panel)
        run: |
          cp CustomRoles.cs CTA/CustomTeamAssigner/CustomRoles.cs
          sed -i 's/Challenger,/SoloPVP_Player,/g' CTA/CustomTeamAssigner/CustomRoles.cs
          dotnet publish CTA/CustomTeamAssigner/CustomTeamAssigner.csproj -c Release -o build/

      # -----------------------------
      # 6. Download BepInEx 6.0.0-pre.2
      # -----------------------------
      - name: Download BepInEx 6.0.0-pre.2
        run: |
          curl -L https://github.com/BepInEx/BepInEx/releases/download/v6.0.0-pre.2/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip -o bepinex.zip
          unzip bepinex.zip -d bepinex

      # -----------------------------
      # 7. Generate changelog automatically
      # -----------------------------
      - name: Generate changelog
        uses: heinrichreimer/action-github-changelog-generator@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          headerLabel: Thank you so much for finding and using EHR!
          output: CHANGELOG.txt

      # -----------------------------
      # 8. Prepare packaging folders
      # -----------------------------
      - name: Prepare packaging structure
        run: |
          mkdir -p release/epic
          mkdir -p release/steam

          # Copy mod DLL
          cp build/*.dll release/epic/
          cp build/*.dll release/steam/

          # Copy Control Panel
          cp build/*.exe release/epic/
          cp build/*.exe release/steam/

          # Copy BepInEx
          cp -r bepinex/* release/epic/
          cp -r bepinex/* release/steam/

          # Steam-only file
          echo "945360" > release/steam/steam_appid.txt

      # -----------------------------
      # 9. Create ZIPs
      # -----------------------------
      - name: Create ZIP archives
        run: |
          cd release
          zip -r "EHR.v${{ github.event.inputs.version }}_Epic-Games_Microsoft-Store.zip" epic/
          zip -r "EHR.v${{ github.event.inputs.version }}_Steam.zip" steam/

      # -----------------------------
      # 10. Create source archives
      # -----------------------------
      - name: Create source code archives
        run: |
          git archive --format zip --output source.zip HEAD
          git archive --format tar.gz --output source.tar.gz HEAD

      # -----------------------------
      # 11. Create tag for this release
      # -----------------------------
      - name: Create tag
        run: |
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      # -----------------------------
      # 12. Create GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "EHR ${{ github.event.inputs.version }}"
          body_path: CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 13. Upload assets
      # -----------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: |
            build/EHR.dll
            build.*.exe
            release/*.zip
            source.zip
            source.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
