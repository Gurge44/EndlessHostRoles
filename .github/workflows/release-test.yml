name: Build & Release EHR TEST

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 7.0.2)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout main
      # -----------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # 2. Download translations from Crowdin
      # -----------------------------
      - name: Stub Crowdin step
        run: echo "Skipping Crowdin sync (no secrets in test mode)"

      # -----------------------------
      # 3. Setup .NET
      # -----------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # -----------------------------
      # 4. Build main mod (EHR)
      # -----------------------------
      - name: Build EHR
        run: |
          dotnet publish EHR.csproj -c Release -o build/

      # -----------------------------
      # 5. Build CTA (Control Panel)
      # -----------------------------
      - name: Build CustomTeamAssigner (Control Panel)
        run: |
          cp CustomRoles.cs CTA/CustomTeamAssigner/CustomRoles.cs
          dotnet publish CTA/CustomTeamAssigner/CustomTeamAssigner.csproj -c Release -o build/

      # -----------------------------
      # 6. Generate changelog automatically
      # -----------------------------
      - name: Generate changelog
        uses: heinrichreimer/action-github-changelog-generator@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          headerLabel: Thank you so much for finding and using EHR!

      # -----------------------------
      # 7. Package ZIPs for Epic/Microsoft and Steam
      # -----------------------------
      - name: Prepare packaging structure
        run: |
          mkdir -p release

          # Download and unzip BepInEx
          curl -L https://github.com/BepInEx/BepInEx/releases/download/v6.0.0-pre.2/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip -o bepinex.zip
          unzip bepinex.zip -d release

          # Copy EHR DLL to plugins
          cp build/EHR.dll release/BepInEx/plugins

          # Download modded regions DLL to plugins
          curl -L https://github.com/miniduikboot/Mini.RegionInstall/releases/download/v1.2.0/Mini.RegionInstall.dll -o release/BepInEx/plugins/Mini.RegionInstall.dll

          cd release
          zip -r "EHR.v${{ github.event.inputs.version }}_Epic-Games_Microsoft-Store.zip"

          # Steam-only file
          echo "945360" > steam_appid.txt

          zip -r "EHR.v${{ github.event.inputs.version }}_Steam.zip"

      # -----------------------------
      # 8. Create GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "EHR ${{ github.event.inputs.version }}"
          body_path: changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 9. Upload assets
      # -----------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: |
            build/EHR.dll
            build/CustomTeamAssigner.exe
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
