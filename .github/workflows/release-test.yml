name: Build & Release EHR TEST

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 7.0.2)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout main
      # -----------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Stub Crowdin step
        run: echo "Skipping Crowdin sync (no secrets in test mode)"


      # -----------------------------
      # 3. Setup .NET
      # -----------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # -----------------------------
      # 4. Build main mod (EHR)
      # -----------------------------
      - name: Build EHR
        run: |
          dotnet publish EHR.csproj -c Release -o build/

      # -----------------------------
      # 5. Build CTA (Control Panel)
      # -----------------------------
      - name: Build CustomTeamAssigner (Control Panel)
        run: |
          cp CustomRoles.cs CTA/CustomTeamAssigner/CustomRoles.cs
          sed -i 's/Challenger,/SoloPVP_Player,/g' CTA/CustomTeamAssigner/CustomRoles.cs
          dotnet publish CTA/CustomTeamAssigner/CustomTeamAssigner.csproj -c Release -o build/

      # -----------------------------
      # 6. Download BepInEx 6.0.0-pre.2
      # -----------------------------
      - name: Download BepInEx 6.0.0-pre.2
        run: |
          curl -L https://github.com/BepInEx/BepInEx/releases/download/v6.0.0-pre.2/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip -o bepinex.zip
          unzip bepinex.zip -d bepinex

      # -----------------------------
      # 7. Download .NET runtime (latest 6.x win-x64)
      # -----------------------------
      - name: Download .NET 6 Runtime
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/dotnet/runtime/releases)

          # Get the latest tag that matches v6.0.x
          TAG=$(echo "$RELEASE_JSON" \
            | jq -r '.[].tag_name' \
            | grep '^v6\.0\.' \
            | sort -Vr \
            | head -n 1)

          echo "Selected tag: $TAG"

          # Get the zipball_url for that tag
          ZIP_URL=$(echo "$RELEASE_JSON" \
            | jq -r --arg TAG "$TAG" '
                .[]
                | select(.tag_name == $TAG)
                | .zipball_url
              ')

          echo "Downloading zipball: $ZIP_URL"
          curl -L "$ZIP_URL" -o dotnet.zip
          unzip dotnet.zip -d dotnet

      # -----------------------------
      # 8. Generate changelog automatically
      # -----------------------------
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, using full history."
            git log --pretty=format:"* %s" > CHANGELOG.txt
          else
            echo "Generating changelog since $LAST_TAG"
            git log $LAST_TAG..HEAD --pretty=format:"* %s" > CHANGELOG.txt
          fi  

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # -----------------------------
      # 9. Prepare packaging folders
      # -----------------------------
      - name: Prepare packaging structure
        run: |
          mkdir -p release/epic
          mkdir -p release/steam

          # Copy mod DLL
          cp build/*.dll release/epic/
          cp build/*.dll release/steam/

          # Copy Control Panel
          cp build/*.exe release/epic/
          cp build/*.exe release/steam/

          # Copy BepInEx
          cp -r bepinex/* release/epic/
          cp -r bepinex/* release/steam/

          # Copy dotnet runtime
          cp -r dotnet/shared release/epic/dotnet
          cp -r dotnet/shared release/steam/dotnet

          # Steam-only file
          echo "945360" > release/steam/steam_appid.txt

          # Generate changelog
          echo CHANGELOG.txt > release/changelog.txt
          cp release/changelog.txt release/epic/
          cp release/changelog.txt release/steam/

      # -----------------------------
      # 10. Create ZIPs
      # -----------------------------
      - name: Create ZIP archives
        run: |
          cd release
          zip -r "EHR.${{ github.event.inputs.version }}_Epic-Games_Microsoft-Store.zip" epic/
          zip -r "EHR.${{ github.event.inputs.version }}_Steam.zip" steam/

      # -----------------------------
      # 11. Create source archives
      # -----------------------------
      - name: Create source code archives
        run: |
          git archive --format zip --output source.zip HEAD
          git archive --format tar.gz --output source.tar.gz HEAD

      # -----------------------------
      # 12. Create tag for this release
      # -----------------------------
      - name: Create tag
        run: |
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      # -----------------------------
      # 13. Create GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "EHR ${{ github.event.inputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # 12. Upload assets
      # -----------------------------
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: |
            build/EHR/EHR.dll
            release/*.zip
            source.zip
            source.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
